{% extends 'base.html' %}

{% block title %} Use Case 3 {% endblock %}

{% block css_links %}
    <link rel="stylesheet" href="{{ url_for('static', filename='use_case_3.css') }}">
{% endblock  %}

{% block block_menu %}{% endblock  %}

{% block content %}
    <div class="">
        <div class="title">
            <h4>Use Case 3</h4>
            <p>This use case is split into two subcases. Provided that the form inputs are valid,
                our solutions for each subcase are as follows:</p>
            <p>Subcase 1: Given a movie title, for every user, we calculate the correlation between 
                the average rating for his/her reviews, and their rating for the specific movie.
            </p>
            <p>Subcase 2: Given a movie title and a specific genre, for every user, we calculate the 
                correlation between the average rating for his/her reviews of movies under the target 
                genre, and their rating for the specific movie.
            </p>
            <p>NOTE: We strictly design our solution based on the requirements, e.g., subcase 1 will
                only produce a solution if the movie title is entered AND the genre is not selected.
            </p>
        </div>
    </div>
    <form class="use-case-3-form-1" action="{{ url_for('uc_3') }}" method="POST">
        <fieldset class="row mb-2">
            <div class="col-sm-2">
                <div class="form-floating">
                    <input type="text" class="form-control" name="movie_title_field" id="search" placeholder="Movie name..."></input>
                    <label for="movie_title_field">Enter movie title</label>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-floating">
                    <select class="form-select" name="genre" id="genre-select">
                        <!-- Add a default option "None" to prevent filtering on genre column -->
                        <option value="" selected>None</option>
                        {% for genre_name in unique_genres %}
                            <option value={{genre_name}}>{{genre_name}}</option>
                        {% endfor %}
                    </select>
                    <label for="genre-select">Select Genre</label>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="form-floating">
                    <select class="form-select" name="selected_subcase" id="selected_subcase">
                        <option value="subcase1" selected>Subcase 1</option>
                        <option value="subcase2">Subcase 2</option>
                    </select>
                    <label for="selected_subcase">Select Subcase</label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary col-sm-2">Search</button>
        </fieldset>
    </form>
    <br>
    <div class="use-case-3-results">
        {% set message = context['message'] %}
        {% if context != None %}
            {% set correlation = context['correlation'] %}
            {% set movie_title = context['movie_title'] %}

            {% if message != None %}
                <p class="message">{{ message }}</p>
                <p>Correlation for {{movie_title}}: {{correlation}}</p>
            {% endif %}
        {% endif %}
    </div>
    <div>
        <canvas id="myChart" height="500"></canvas>
    </div>
    <script>
        var ctx = document.getElementById("myChart").getContext("2d");
        var context = {{ context|tojson }};
        var labels = context['labels'];
        var query_res = context['query_res'];
        var movie_title = context['movie_title'];

        let data = {
            datasets: [{
                type: "scatter",
                label: "User ratings for " + movie_title,
                labels: labels,
                data: query_res,
                backgroundColor: "#0D6EFD"
            }]
        }

        let options = {
            scales: {
                x: {
                    min: 0,
                    max: 5,
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'User Rating for ' + movie_title
                    }
                },
                y: {
                    min: 0,
                    max: 5,
                    title: {
                        display: true,
                        text: 'User Average Rating History'
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.dataset.labels[ctx.dataIndex];
                            return [label, "User Rating for " + movie_title + ": " + ctx.parsed.x, "User Average Rating: " + ctx.parsed.y]
                        }
                    }
                }
            }
        }

        scatterChart = new Chart(ctx, {
            data: data,
            options: options
        });
    </script>
{% endblock  %}